<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantina Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for better UX on desktop */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Basic transition for view changes */
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <header class="bg-orange-500 text-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold cursor-pointer" onclick="navigateTo('productList')">Cantina Digital <i class="fas fa-utensils"></i></h1>
            <nav class="flex items-center space-x-4">
                <button id="cartButton" onclick="showCartView()" class="relative hover:text-orange-200 transition duration-150">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <button id="adminLoginButton" onclick="showAdminLoginView()" class="hover:text-orange-200 transition duration-150 md:hidden">
                    <i class="fas fa-user-shield text-xl"></i>
                </button>
                 <button id="adminAccessButtonDesktop" onclick="handleAdminAccessDesktop()" class="hidden md:block bg-white text-orange-500 px-3 py-1 rounded-md hover:bg-orange-100 transition duration-150 text-sm font-medium">
                    Admin
                </button>
            </nav>
        </div>
    </header>

    <main id="mainContent" class="container mx-auto px-4 pt-20 pb-16 md:pt-24">
        <section id="productList" class="view">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-semibold text-gray-700">Nossos Produtos üçîü•§</h2>
                <div class="w-full md:w-1/3">
                    <input type="text" id="searchInput" placeholder="Buscar produtos..." class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
            </div>
            <div id="productListContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </section>

        <div id="cartViewModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4 modal">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">Seu Carrinho <i class="fas fa-shopping-bag"></i></h3>
                    <button onclick="closeModal('cartViewModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="cartItemsContainer" class="p-4 space-y-3 overflow-y-auto">
                    </div>
                <div class="p-4 border-t mt-auto">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-semibold text-gray-700">Total:</span>
                        <span id="cartTotal" class="text-xl font-bold text-orange-600">R$ 0.00</span>
                    </div>
                    <button id="checkoutButton" onclick="checkout()" class="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 transition duration-150 font-semibold text-lg focus:outline-none focus:ring-2 focus:ring-orange-400">
                        Finalizar Pedido <i class="fas fa-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="orderConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
                <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                <h3 class="text-2xl font-semibold text-gray-800 mb-2">Pedido Realizado!</h3>
                <p class="text-gray-600 mb-1">Seu c√≥digo para retirada √©:</p>
                <p id="pickupCode" class="text-3xl font-bold text-orange-600 bg-orange-100 py-2 px-4 rounded-lg inline-block my-3"></p>
                <p class="text-gray-600 mb-4">Valor Total: <span id="orderTotalValue" class="font-semibold"></span></p>
                <button onclick="closeModal('orderConfirmationModal'); navigateTo('productList');" class="bg-orange-500 text-white py-2 px-6 rounded-lg hover:bg-orange-600 transition duration-150">
                    Voltar aos Produtos
                </button>
            </div>
        </div>

        <section id="adminLoginView" class="view">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg mt-10">
                <h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">Acesso Admin <i class="fas fa-key"></i></h2>
                <form id="adminLoginForm">
                    <div class="mb-4">
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Chave de API</label>
                        <input type="password" id="apiKey" name="apiKey" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Sua chave secreta">
                    </div>
                    <button type="submit" class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition duration-150 font-semibold">Entrar</button>
                </form>
                 <p class="text-center mt-4"><button onclick="navigateTo('productList')" class="text-sm text-orange-500 hover:underline">Voltar para a loja</button></p>
            </div>
        </section>

        <section id="adminDashboardView" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Painel Admin <i class="fas fa-tachometer-alt"></i></h2>
                <button onclick="adminLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-150 text-sm">Sair <i class="fas fa-sign-out-alt"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-1">Ganhos de Hoje</h3>
                    <p id="dailyEarnings" class="text-3xl font-bold text-green-500">R$ 0.00</p>
                    <p id="dailyOrdersCount" class="text-sm text-gray-500">0 pedidos hoje</p>
                     <input type="date" id="earningsDate" class="mt-2 p-1 border rounded text-sm">
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-center items-center">
                     <h3 class="text-lg font-semibold text-gray-700 mb-2">A√ß√µes R√°pidas</h3>
                    <button onclick="navigateTo('adminProductManagementView')" class="w-full md:w-auto mb-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150">Gerenciar Produtos <i class="fas fa-box-open"></i></button>
                    <button onclick="navigateTo('adminOrderListView')" class="w-full md:w-auto bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-150">Ver Pedidos <i class="fas fa-list-alt"></i></button>
                </div>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                 <h3 class="text-xl font-semibold text-gray-700 mb-4">√öltimos Pedidos</h3>
                 <div id="adminDashboardOrdersContainer" class="overflow-x-auto max-h-96">
                     </div>
            </div>
        </section>

        <section id="adminProductManagementView" class="view">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Produtos <i class="fas fa-edit"></i></h2>
                <div>
                    <button onclick="showProductFormModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-150 mr-2">Novo Produto <i class="fas fa-plus-circle"></i></button>
                    <button onclick="navigateTo('adminDashboardView')" class="text-sm text-orange-500 hover:underline">Voltar ao Painel</button>
                </div>
            </div>
            <div id="adminProductListContainer" class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                </div>
        </section>

        <section id="adminOrderListView" class="view">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-700">Todos os Pedidos <i class="fas fa-receipt"></i></h2>
                <button onclick="navigateTo('adminDashboardView')" class="text-sm text-orange-500 hover:underline">Voltar ao Painel</button>
            </div>
            <div id="adminOrdersFullListContainer" class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                </div>
        </section>

        <div id="productFormModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4 modal">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 id="productFormTitle" class="text-xl font-semibold text-gray-800">Adicionar Produto</h3>
                    <button onclick="closeModal('productFormModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <form id="productForm" class="p-4 space-y-3 overflow-y-auto">
                    <input type="hidden" id="productId">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" id="productName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="productDescription" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                        <textarea id="productDescription" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700">Pre√ßo (R$)</label>
                        <input type="number" id="productPrice" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="productCategory" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <input type="text" id="productCategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Ex: Salgados, Bebidas">
                    </div>
                    <div>
                        <label for="productImageUrl" class="block text-sm font-medium text-gray-700">URL da Imagem</label>
                        <input type="url" id="productImageUrl" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="https://exemplo.com/imagem.jpg">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="productAvailable" checked class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                        <label for="productAvailable" class="ml-2 block text-sm text-gray-900">Dispon√≠vel</label>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="w-full bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 font-semibold">Salvar Produto</button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <div id="toastNotification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg text-sm hidden animate-pulse z-50">
        <span id="toastMessage"></span>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]">
        <div class="p-5 bg-white rounded-lg flex items-center space-x-3">
            <i class="fas fa-spinner fa-spin text-orange-500 text-2xl"></i>
            <span class="text-gray-700">Carregando...</span>
        </div>
    </div>


    <script>
        // #####################################################################
        // # CONFIGURATION                                                     #
        // #####################################################################
        const API_BASE_URL = 'SUA_URL_DA_API_HOSPEDADA_AQUI'; //  IMPORTANT√çSSIMO: Substitua pela URL da sua API! Ex: 'https://sua-api.onrender.com'
        const ADMIN_API_KEY_STORAGE = 'cantinaAdminApiKey';
        const CART_STORAGE_KEY = 'cantinaCart';

        // #####################################################################
        // # GLOBAL STATE & UTILITIES                                          #
        // #####################################################################
        let currentView = 'productList';
        let cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY)) || [];

        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        function showLoading(show = true) {
            $('#loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showToast(message, type = 'success', duration = 3000) {
            const toast = $('#toastNotification');
            const toastMessage = $('#toastMessage');
            toastMessage.textContent = message;

            toast.classList.remove('bg-gray-800', 'bg-red-600', 'bg-green-600', 'bg-blue-600');
            if (type === 'error') toast.classList.add('bg-red-600');
            else if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'info') toast.classList.add('bg-blue-600');
            else toast.classList.add('bg-gray-800');

            toast.style.display = 'block';
            toast.classList.remove('animate-pulse'); // ensure it's not pulsing initially
            void toast.offsetWidth; // Trigger reflow to restart animation
            toast.classList.add('animate-pulse');


            setTimeout(() => {
                toast.style.display = 'none';
                toast.classList.remove('animate-pulse');
            }, duration);
        }

        function formatCurrency(value) {
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // #####################################################################
        // # VIEW NAVIGATION / ROUTING                                         #
        // #####################################################################
        function navigateTo(viewId) {
            $$('.view').forEach(view => view.classList.remove('active'));
            const targetView = $(`#${viewId}`);
            if (targetView) {
                targetView.classList.add('active');
                currentView = viewId;
                window.scrollTo(0, 0); // Scroll to top on view change

                // Special actions based on view
                if (viewId === 'productList') loadProducts();
                if (viewId === 'adminDashboardView') loadAdminDashboard();
                if (viewId === 'adminProductManagementView') loadAdminProducts();
                if (viewId === 'adminOrderListView') loadAdminFullOrders();
            } else {
                console.error(`View with id ${viewId} not found.`);
                navigateTo('productList'); // Fallback to product list
            }
            updateAdminButtonVisibility();
            closeAllModals(); // Close any open modals on view change
        }

        function closeModal(modalId) {
            const modal = $(`#${modalId}`);
            if (modal) modal.style.display = 'none';
        }
        function closeAllModals() {
            closeModal('cartViewModal');
            closeModal('orderConfirmationModal');
            closeModal('productFormModal');
        }

        function showModal(modalId) {
            const modal = $(`#${modalId}`);
            if (modal) modal.style.display = 'flex';
        }


        // #####################################################################
        // # API INTERACTION                                                   #
        // #####################################################################
        async function apiRequest(endpoint, method = 'GET', body = null, requiresAdmin = false) {
            showLoading();
            const headers = { 'Content-Type': 'application/json' };
            if (requiresAdmin) {
                const apiKey = localStorage.getItem(ADMIN_API_KEY_STORAGE);
                if (!apiKey) {
                    showLoading(false);
                    showToast('Acesso de Admin n√£o configurado.', 'error');
                    navigateTo('adminLoginView');
                    return null;
                }
                headers['X-API-KEY'] = apiKey;
            }

            const config = { method, headers };
            if (body) config.body = JSON.stringify(body);

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                showLoading(false);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ erro: `Erro ${response.status}: ${response.statusText}` }));
                    console.error('API Error:', errorData);
                    showToast(errorData.erro || `Erro na requisi√ß√£o: ${response.status}`, 'error');
                    if (response.status === 401 && requiresAdmin) { // Unauthorized admin
                        adminLogout(); // Log out admin
                        navigateTo('adminLoginView');
                    }
                    return null;
                }
                if (response.status === 204) return true; // No content, but successful (e.g. DELETE)
                return await response.json();
            } catch (error) {
                showLoading(false);
                console.error('Fetch Error:', error);
                showToast('Erro de conex√£o com o servidor. Tente mais tarde.', 'error');
                return null;
            }
        }

        // #####################################################################
        // # AUTHENTICATION (Admin)                                            #
        // #####################################################################
        $('#adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKey = $('#apiKey').value;
            // Simple test: try to fetch admin orders. If successful, key is valid.
            showLoading();
            const testHeaders = { 'X-API-KEY': apiKey, 'Content-Type': 'application/json' };
            try {
                const response = await fetch(`${API_BASE_URL}/admin/pedidos?limit=1`, { headers: testHeaders }); // test endpoint
                showLoading(false);
                if (response.ok) {
                    localStorage.setItem(ADMIN_API_KEY_STORAGE, apiKey);
                    $('#apiKey').value = '';
                    showToast('Login de Admin bem-sucedido!', 'success');
                    navigateTo('adminDashboardView');
                } else {
                     const errorData = await response.json().catch(() => ({ erro: `Chave de API inv√°lida.` }));
                    showToast(errorData.erro || 'Chave de API inv√°lida.', 'error');
                }
            } catch (error) {
                showLoading(false);
                showToast('Erro ao validar chave de API. Verifique a conex√£o.', 'error');
            }
        });

        function adminLogout() {
            localStorage.removeItem(ADMIN_API_KEY_STORAGE);
            showToast('Voc√™ saiu da √°rea de Admin.', 'info');
            navigateTo('productList');
        }

        function isAdminLoggedIn() {
            return !!localStorage.getItem(ADMIN_API_KEY_STORAGE);
        }

        function updateAdminButtonVisibility() {
            const adminButtonDesktop = $('#adminAccessButtonDesktop');
            const adminButtonMobile = $('#adminLoginButton'); // This one is for login, might need another for dashboard access if logged in
            if (isAdminLoggedIn()) {
                adminButtonDesktop.textContent = 'Painel Admin';
                adminButtonDesktop.onclick = () => navigateTo('adminDashboardView');
                adminButtonMobile.style.display = 'none'; // Hide login button on mobile if logged in
                 // Potentially add a different admin access button for mobile when logged in
            } else {
                adminButtonDesktop.textContent = 'Admin';
                adminButtonDesktop.onclick = () => showAdminLoginView();
                adminButtonMobile.style.display = 'block';
            }
        }
        function handleAdminAccessDesktop() {
            if(isAdminLoggedIn()) navigateTo('adminDashboardView');
            else showAdminLoginView();
        }


        // #####################################################################
        // # CART LOGIC                                                        #
        // #####################################################################
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantidade, 0);
            $('#cartCount').textContent = count;
        }

        function saveCart() {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            updateCartCount();
            renderCartItems(); // Re-render cart items whenever cart changes
        }

        function addToCart(product, quantity = 1) {
            if (!product || product.preco == null) {
                console.error("Produto inv√°lido para adicionar ao carrinho:", product);
                showToast("Erro: N√£o foi poss√≠vel adicionar o produto.", "error");
                return;
            }
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantidade += quantity;
            } else {
                cart.push({ ...product, quantidade: quantity });
            }
            saveCart();
            showToast(`${product.nome} adicionado ao carrinho!`, 'success');
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
        }

        function updateCartItemQuantity(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                if (newQuantity <= 0) {
                    removeFromCart(productId);
                } else {
                    item.quantidade = newQuantity;
                    saveCart();
                }
            }
        }

        function clearCart() {
            cart = [];
            saveCart();
        }

        async function checkout() {
            if (cart.length === 0) {
                showToast('Seu carrinho est√° vazio!', 'info');
                return;
            }
            const orderData = {
                itens: cart.map(item => ({ produto_id: item.id, quantidade: item.quantidade }))
                // cliente_identificador: 'opcional_aqui' // Se quiser implementar
            };
            const result = await apiRequest('/pedidos', 'POST', orderData);
            if (result) {
                $('#pickupCode').textContent = result.codigo_retirada;
                $('#orderTotalValue').textContent = formatCurrency(result.valor_total);
                showModal('orderConfirmationModal');
                closeModal('cartViewModal');
                clearCart();
            }
        }

        // #####################################################################
        // # RENDERING FUNCTIONS                                               #
        // #####################################################################

        // --- Client Rendering ---
        function renderProductCard(product) {
            const imageUrl = product.imagem_url || 'https://via.placeholder.com/300x200.png?text=Sem+Imagem';
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col transform hover:scale-105 transition-transform duration-300">
                    <img src="${imageUrl}" alt="${product.nome}" class="w-full h-48 object-cover">
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1 truncate" title="${product.nome}">${product.nome}</h3>
                        <p class="text-sm text-gray-600 mb-2 flex-grow min-h-[40px]">${product.descricao || 'Sem descri√ß√£o.'}</p>
                        <p class="text-xs text-gray-500 mb-2">Categoria: ${product.categoria || 'Geral'}</p>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="text-xl font-bold text-orange-600">${formatCurrency(product.preco)}</span>
                            <button onclick='addToCart(${JSON.stringify(product)})' class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition duration-150 text-sm font-medium">
                                <i class="fas fa-cart-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadProducts(searchTerm = '') {
            let endpoint = '/produtos';
            if (searchTerm) {
                endpoint += `?busca=${encodeURIComponent(searchTerm)}`;
            }
            const products = await apiRequest(endpoint);
            const container = $('#productListContainer');
            if (products && container) {
                if (products.length === 0) {
                    container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">Nenhum produto encontrado.</p>`;
                } else {
                    container.innerHTML = products.map(renderProductCard).join('');
                }
            } else if (container) {
                 container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">N√£o foi poss√≠vel carregar os produtos.</p>`;
            }
        }

        $('#searchInput').addEventListener('input', (e) => {
            // Basic debounce
            if (this.searchTimeout) clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                loadProducts(e.target.value.trim());
            }, 300);
        });


        function renderCartItem(item) {
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md shadow-sm" data-product-id="${item.id}">
                    <div class="flex items-center">
                        <img src="${item.imagem_url || 'https://via.placeholder.com/50'}" alt="${item.nome}" class="w-12 h-12 object-cover rounded mr-3">
                        <div>
                            <h4 class="font-semibold text-gray-700 text-sm">${item.nome}</h4>
                            <p class="text-xs text-gray-500">${formatCurrency(item.preco)}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="number" value="${item.quantidade}" min="1" onchange="updateCartItemQuantity(${item.id}, parseInt(this.value))" class="w-14 text-center border border-gray-300 rounded-md py-1 px-1 text-sm mx-2">
                        <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700 text-lg"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            `;
        }

        function renderCartItems() {
            const container = $('#cartItemsContainer');
            const cartTotalEl = $('#cartTotal');
            if (cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Seu carrinho est√° vazio.</p>';
                cartTotalEl.textContent = formatCurrency(0);
                $('#checkoutButton').disabled = true;
                $('#checkoutButton').classList.add('opacity-50', 'cursor-not-allowed');

            } else {
                container.innerHTML = cart.map(renderCartItem).join('');
                const total = cart.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
                cartTotalEl.textContent = formatCurrency(total);
                $('#checkoutButton').disabled = false;
                $('#checkoutButton').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function showCartView() {
            renderCartItems();
            showModal('cartViewModal');
        }


        // --- Admin Rendering ---
        async function loadAdminDashboard() {
            const earningsDateInput = $('#earningsDate');
            const selectedDate = earningsDateInput.value || new Date().toISOString().split('T')[0]; // YYYY-MM-DD

            const report = await apiRequest(`/admin/relatorios/ganhos?data=${selectedDate}`, 'GET', null, true);
            if (report) {
                $('#dailyEarnings').textContent = formatCurrency(report.total_ganhos);
                $('#dailyOrdersCount').textContent = `${report.quantidade_pedidos_no_dia} pedidos em ${new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR')}`;
            }
            earningsDateInput.value = selectedDate; // ensure it's set

            // Load some recent orders for the dashboard
            const recentOrders = await apiRequest('/admin/pedidos?limit=5', 'GET', null, true); // Assuming API supports limit
             const dashboardOrdersContainer = $('#adminDashboardOrdersContainer');
            if(recentOrders && dashboardOrdersContainer){
                if(recentOrders.length === 0){
                    dashboardOrdersContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum pedido recente.</p>`;
                } else {
                    dashboardOrdersContainer.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                    <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-2 text-left font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${recentOrders.slice(0, 5).map(order => `
                                    <tr>
                                        <td class="px-4 py-2 whitespace-nowrap text-orange-600 font-medium">${order.codigo_retirada}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(order.status)}">
                                                ${order.status}
                                            </span>
                                        </td>
                                        <td class="px-4 py-2 whitespace-nowrap font-medium">${formatCurrency(order.valor_total)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } else if (dashboardOrdersContainer) {
                 dashboardOrdersContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Erro ao carregar pedidos.</p>`;
            }
        }
        $('#earningsDate').addEventListener('change', loadAdminDashboard);


        function renderAdminProductRow(product) {
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <img src="${product.imagem_url || 'https://via.placeholder.com/40'}" alt="${product.nome}" class="w-10 h-10 object-cover rounded-md inline-block mr-2">
                        <span class="font-medium text-gray-800">${product.nome}</span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatCurrency(product.preco)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${product.categoria || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${product.disponivel ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${product.disponivel ? 'Dispon√≠vel' : 'Indispon√≠vel'}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='showProductFormModal(${JSON.stringify(product)})' class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i> Editar</button>
                        <button onclick='deleteAdminProduct(${product.id}, "${product.nome}")' class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i> Deletar</button>
                    </td>
                </tr>
            `;
        }

        async function loadAdminProducts() {
            const products = await apiRequest('/admin/produtos', 'GET', null, true);
            const container = $('#adminProductListContainer');
            if (products && container) {
                if (products.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-6">Nenhum produto cadastrado.</p>`;
                } else {
                container.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${products.map(renderAdminProductRow).join('')}
                        </tbody>
                    </table>
                `;
                }
            } else if (container) {
                 container.innerHTML = `<p class="text-center text-gray-500 py-6">Erro ao carregar produtos.</p>`;
            }
        }

        function showProductFormModal(productToEdit = null) {
            const form = $('#productForm');
            form.reset(); // Reset form fields
            $('#productId').value = '';

            if (productToEdit) {
                $('#productFormTitle').textContent = 'Editar Produto';
                $('#productId').value = productToEdit.id;
                $('#productName').value = productToEdit.nome;
                $('#productDescription').value = productToEdit.descricao || '';
                $('#productPrice').value = productToEdit.preco;
                $('#productCategory').value = productToEdit.categoria || '';
                $('#productImageUrl').value = productToEdit.imagem_url || '';
                $('#productAvailable').checked = productToEdit.disponivel;
            } else {
                $('#productFormTitle').textContent = 'Adicionar Novo Produto';
            }
            showModal('productFormModal');
        }

        $('#productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = $('#productId').value;
            const productData = {
                nome: $('#productName').value,
                descricao: $('#productDescription').value,
                preco: parseFloat($('#productPrice').value),
                categoria: $('#productCategory').value,
                imagem_url: $('#productImageUrl').value,
                disponivel: $('#productAvailable').checked
            };

            let result;
            if (productId) { // Editing
                result = await apiRequest(`/admin/produtos/${productId}`, 'PUT', productData, true);
            } else { // Creating
                result = await apiRequest('/admin/produtos', 'POST', productData, true);
            }

            if (result) {
                showToast(`Produto ${productId ? 'atualizado' : 'adicionado'} com sucesso!`, 'success');
                closeModal('productFormModal');
                loadAdminProducts(); // Refresh product list
            }
        });

        async function deleteAdminProduct(productId, productName) {
            if (confirm(`Tem certeza que deseja deletar o produto "${productName}"?`)) {
                const result = await apiRequest(`/admin/produtos/${productId}`, 'DELETE', null, true);
                if (result) { // apiRequest returns true for 204 No Content
                    showToast(`Produto "${productName}" deletado com sucesso!`, 'success');
                    loadAdminProducts();
                }
            }
        }

        function getStatusColor(status) {
            switch (status.toUpperCase()) {
                case 'PENDENTE': return 'bg-yellow-100 text-yellow-800';
                case 'PREPARANDO': return 'bg-blue-100 text-blue-800';
                case 'PRONTO': return 'bg-green-100 text-green-800';
                case 'ENTREGUE': return 'bg-purple-100 text-purple-800';
                case 'CANCELADO': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function renderAdminOrderRow(order, isFullView = false) {
            const itemsSummary = order.itens.map(item => `${item.quantidade}x ${item.produto_nome}`).join(', ');
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap font-medium text-orange-600">${order.codigo_retirada}</td>
                    ${isFullView ? `<td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${new Date(order.data_hora).toLocaleString('pt-BR')}</td>` : ''}
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 truncate max-w-xs" title="${itemsSummary}">${itemsSummary}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-semibold">${formatCurrency(order.valor_total)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <select class="status-select text-xs p-1 rounded-md border-gray-300 focus:ring-orange-500 focus:border-orange-500 ${getStatusColor(order.status).replace('bg-', 'border-').replace('text-', 'text-')} ${getStatusColor(order.status)}" data-order-code="${order.codigo_retirada}" onchange="updateOrderStatus(this)">
                            <option value="PENDENTE" ${order.status === 'PENDENTE' ? 'selected' : ''}>Pendente</option>
                            <option value="PREPARANDO" ${order.status === 'PREPARANDO' ? 'selected' : ''}>Preparando</option>
                            <option value="PRONTO" ${order.status === 'PRONTO' ? 'selected' : ''}>Pronto</option>
                            <option value="ENTREGUE" ${order.status === 'ENTREGUE' ? 'selected' : ''}>Entregue</option>
                            <option value="CANCELADO" ${order.status === 'CANCELADO' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </td>
                </tr>
            `;
        }
        async function loadAdminFullOrders() {
            const orders = await apiRequest('/admin/pedidos', 'GET', null, true);
            const container = $('#adminOrdersFullListContainer');
             if (orders && container) {
                if (orders.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-6">Nenhum pedido encontrado.</p>`;
                } else {
                    container.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${orders.map(order => renderAdminOrderRow(order, true)).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } else if (container) {
                 container.innerHTML = `<p class="text-center text-gray-500 py-6">Erro ao carregar pedidos.</p>`;
            }
        }

        async function updateOrderStatus(selectElement) {
            const orderCode = selectElement.dataset.orderCode;
            const newStatus = selectElement.value;
            const result = await apiRequest(`/admin/pedidos/${orderCode}/status`, 'PUT', { status: newStatus }, true);
            if (result) {
                showToast(`Status do pedido ${orderCode} atualizado para ${newStatus}!`, 'success');
                // Optionally, refresh the list or just update the color of the select
                selectElement.className = `status-select text-xs p-1 rounded-md border-gray-300 focus:ring-orange-500 focus:border-orange-500 ${getStatusColor(newStatus).replace('bg-', 'border-').replace('text-', 'text-')} ${getStatusColor(newStatus)}`;

                // Refresh relevant view if open
                if(currentView === 'adminDashboardView') loadAdminDashboard();
                if(currentView === 'adminOrderListView') loadAdminFullOrders();
            } else {
                showToast(`Erro ao atualizar status do pedido ${orderCode}.`, 'error');
                // Revert select to old status (might need to store old status or re-fetch)
                 if(currentView === 'adminDashboardView') loadAdminDashboard(); // Quick revert by reloading
                 if(currentView === 'adminOrderListView') loadAdminFullOrders();
            }
        }

        function showAdminLoginView() {
            if (isAdminLoggedIn()) {
                navigateTo('adminDashboardView');
            } else {
                navigateTo('adminLoginView');
            }
        }

        // #####################################################################
        // # INITIALIZATION                                                    #
        // #####################################################################
        document.addEventListener('DOMContentLoaded', () => {
            if (API_BASE_URL === 'SUA_URL_DA_API_HOSPEDADA_AQUI' || !API_BASE_URL) {
                document.body.innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center bg-red-100 p-4">
                        <h1 class="text-3xl font-bold text-red-700 mb-4">Erro de Configura√ß√£o!</h1>
                        <p class="text-red-600 text-center">A vari√°vel <code class="bg-red-200 p-1 rounded">API_BASE_URL</code> n√£o foi configurada no JavaScript.</p>
                        <p class="text-red-600 text-center mt-2">Por favor, edite o arquivo HTML e substitua o valor de <code class="bg-red-200 p-1 rounded">'SUA_URL_DA_API_HOSPEDADA_AQUI'</code> pela URL da sua API backend.</p>
                    </div>
                `;
                return;
            }

            updateCartCount();
            updateAdminButtonVisibility();

            // Determine initial view based on hash or admin login state
            const hash = window.location.hash.substring(1);
            if (hash && $(`#${hash}`)) {
                 navigateTo(hash);
            } else if (isAdminLoggedIn()) {
                navigateTo('adminDashboardView');
            } else {
                navigateTo('productList');
            }

            // Simple hash-based routing listener
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.substring(1);
                 if (hash && $(`#${hash}`)) {
                    navigateTo(hash);
                } else if (!hash) {
                    navigateTo(isAdminLoggedIn() ? 'adminDashboardView' : 'productList');
                }
            });
        });

    </script>
</body>
</html>